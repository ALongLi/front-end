# csrf 攻击原理以及防范

`CSRF（Cross-site request forgery）`，中文名称：跨站请求伪造，攻击者盗用了你的身份，以你的名义发送恶意请求。导致个人隐私泄露以及财产安全。

## 攻击原理

在网络层面要完成一次 `CSRF` 攻击，受害者必须依次完成两个步骤：

1. 登录受信任网站 A，并在本地生成 `Cookie。`
2. 在不登出 A 的情况下，访问危险网站 B。
3. B 携带着 A 的 `Cookie` 信息访问服务端

这时候服务器并不能区分 B 的访问是非法的。

## CSRF 防御

### 验证 HTTP Referer 字段

根据 `HTTP` 协议，在 `HTTP` 头中有一个字段叫 `Referer`，它记录了该 `HTTP` 请求的来源地址。如果 `Referer` 开头的域名是自己的网站，则说明该请求是来自银行网站自己的请求，是合法的。如果 `Referer` 是其他网站的话，则有可能是黑客的 `CSRF` 攻击，拒绝该请求。

这种方式如果在前后端分离的情况下就不太合适，特别是牵涉到第三方应用的场景。

前后端分离一般是设置反向代理。有时候可能突然更改了前端服务地址，这时候验证 `Referer` 就会失败。

第三方应用会很多，也可能会随时更改服务地址。而且第三方服务还会牵涉到跨域的问题，`这里跨域建议开启白名单策略，不能所有的接口请求都接受`

### 在请求地址中添加 token 并验证

可以在 `HTTP` 请求中以参数的形式加入一个随机产生的 `token`，并在服务器端建立一个拦截器来验证这个 `token`，如果请求中没有 `token` 或者 `token` 内容不正确，则认为可能是 `CSRF` 攻击而拒绝该请求。

`公司的漏扫工具就是基于这个原理来扫描的`。所以要在 form 表单里加一个隐藏 input

### 在 HTTP 头中自定义属性并验证

这种方法也是使用 `token` 并进行验证，和上一种方法不同的是，这里并不是把 `token` 以参数的形式置于 `HTTP` 请求之中，而是把它放到 `HTTP` 头中自定义的属性里。

`目前研发开发的服务都是基于这个方式`

以上方式基本解决了在网页端的防范，但是还有情况就是通过抓包获取到了你的 `token`，这时候依然可以使用。对于这种可以多加一些防范。

1. `cookie` + `token`，其中 cookie 设置为 `http-only`，防止客户端通过代码获取到
2. `token` 二次加密
3. `https` 校验证书，防止抓包。
4. 对接口进行请求参数签名（推荐）

   以上方式也可以结合使用

当然在浏览器端绝对的安全没有，我们只能尽量防范。防止网站信息泄露，如果攻击者连网站都不知道，肯定就攻击不到了。

服务端还可以做一些敏感行为，例如 平常都是在 河南某个地址，突然又一天在 安徽某个地址访问了，就可以推送用户告警。

不像客户端，客户端甚至可以和设备绑定，即便你账号密码都正确，设备不正确都不能登录。
