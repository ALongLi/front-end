# 信息完整性

一直以来前端都只是调用后台的接口传递参数，其他的都基本不管，直到经历了各种漏洞扫描，安全测试问题更改，接下来主要说一下如何保证接口安全。

## 主要的安全问题

1. 防伪装攻击（案例：csrf）
2. 防篡改攻击（案例： 在传输过程内容被修改）
3. 防数据信息泄漏（案例：敏感信息密码等明文传输）

## 解决方案设计原则

1. 新项目易于开发
2. 老项目易于接入
3. 解决上述描述的安全问题

## 设计思路

对接口参数进行签名，查了下签名算法基本就是那些，这里使用和登录相关的算法 `md5` 和 `hmac-sha512`。

| 参数名    | 类型   | 必选 | 描述                                                                                                             |
| --------- | ------ | ---- | ---------------------------------------------------------------------------------------------------------------- |
| SecretKey | string | true | 签名临时密钥，通过后台接口获取                                                                                   |
| KeyTime   | string | true | 时间戳，包含开始时间结束时间 ， 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误 |
|           |
| params    | string | true | 请求参数 json 字符串                                                                                             |

## 签名步骤

### 步骤 1：生成 KeyTime

1. 获取当前时间对应的 Unix 时间戳 StartTimestamp，Unix 时间戳是从 UTC（协调世界时，或 GMT 格林威治时间）1970 年 1 月 1 日 0 时 0 分 0 秒（北京时间 1970 年 1 月 1 日 8 时 0 分 0 秒）起至现在的总秒数。
2. 根据上述时间戳和期望的签名有效时长算出签名过期时间对应的 Unix 时间戳 EndTimestamp。

3. 拼接签名有效时间，格式为 StartTimestamp;EndTimestamp，即为 KeyTime。例如：1557902800;1557910000。

### 步骤 2：生成 SignKey

使用 `HMAC-SH512` 以 SecretKey 为密钥，以 `md5`后的`KeyTime` 为消息，计算消息摘要，即为 SignKey，例如：`2da144479d80149fb221d620a750ca106dd9787a0f037c76b33e5e48bd8f6fc5b6e1a15bb767663063501e663505c37f81d9ff32809b145a61c281c78e475b5e`。

### 步骤 3：生成 params string

将 object 请求参数格式化为 json 字符串

### 步骤 4：生成 Signature

使用`HMAC-SH512` 以 `SignKey` 为密钥（字符串形式，非原始二进制），以 `params` 为消息，计算消息摘要，即为 Signature，例如：`2da144479d80149fb221d620a750ca106dd9787a0f037c76b33e5e48bd8f6fc5b6e1a15bb767663063501e663505c37f81d9ff32809b145a61c281c78e475b5e`。

## 使用范围

1. 请求格式为`application/json`
2. 所有写操作接口（增、删、改 操作）

## 总结

1. 接口调用方在调用时把加密后的签名（Signature） 放在请求头去请求接口
2. 接口提供方接到响应后，判断时间戳是不是在有效时间
3. 接口调用方和接口提供方约定好统一的参数加密算法，如上。计算请求参数的签名对比是否一致
